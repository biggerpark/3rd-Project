<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.green.jobdone.service.ServiceMapper">
    <insert id="insService" keyProperty="serviceId" useGeneratedKeys="true">
        insert into service
        (userId , productId, price, lat, lng, address, comment, phone, name)
        values
        (#{userId} , #{productId}, #{price}, #{lat}, #{lng}, #{address}, #{comment}, #{phone}, #{name})
    </insert>

    <insert id="insServiceDetail">
        insert into service_detail
        (serviceId, startTime)
        values
        (#{serviceId}, #{startTime})
    </insert>

    <resultMap id="serviceFlow" type="com.green.jobdone.service.model.ServiceGetRes">
        <id property="serviceId" column="serviceId"/>
        <result property="userName" column="userName"/>
        <result property="userPhone" column="userPhone"/>
        <result property="businessName" column="businessName"/>
        <result property="reservedName" column="reservedName"/>
        <result property="productName" column="productName"/>
        <result property="address" column="address"/>
        <result property="price" column="price"/>
        <result property="completed" column="completed"/>
        <result property="comment" column="comment"/>
        <result property="addComment" column="addComment"/>
        <result property="startDate" column="startDate"/>
        <result property="endDate" column="endDate"/>
        <result property="mStartTime" column="mStartTime"/>
        <result property="mEndTime" column="mEndTime"/>
        <result property="businessNum" column="businessNum"/>
        <result property="createdAt" column="createdAt"/>
        <result property="categoryName" column="categoryName"/>
        <collection property="options" resultMap="servicePhone"/>
        <collection property="phone" resultMap="serviceOption"/>
    </resultMap>
    <resultMap id="servicePhone" type="com.green.jobdone.service.model.ServicePhone">
        <result property="businessPhone" column="businessPhone"/>
    </resultMap>

    <resultMap id="serviceOption" type="com.green.jobdone.service.model.ServiceOptionDto">
        <id property="productOptionId" column="productOptionId"/>
        <result property="optionName" column="optionName"/>
        <collection property="optionDetails" resultMap="serviceOptionDetail"/>
    </resultMap>

    <resultMap id="serviceOptionDetail" type="com.green.jobdone.service.model.OptionDetailDto">
        <id property="optionDetailId" column="optionDetailId"/>
        <result property="detailName" column="detailName"/>
        <result property="detailPrice" column="detailPrice"/>
        <result property="contents" column="contents"/>
    </resultMap>

    <select id="GetServiceOne" resultMap="serviceFlow">
        select a.serviceId, a.name as userName, a.phone as userPhone, d.businessName as businessName, b.name as reservedName,
        e.name as productName, a.price, a.completed, a.address, a.comment, a.addComment, a.createdAt,
        k.startDate, k.endDate, k.mStartTime, k.mEndTime, d.businessNum, l.categoryName, group_concat(distinct j.phone) as businessPhone,
        g.productOptionId, g.name as optionName, i.name as detailName, i.contents, i.price as detailPrice, i.optionDetailId
        from service a
        left join user b on a.userId = b.userId
        left join product c on a.productId = c.productId
        left join business d on c.businessId = d.businessId
        left join detail_type e on c.detailTypeId = e.detailTypeId
        left join service_option f on a.serviceId = f.serviceId
        left join product_option g on f.productOptionId = g.productOptionId
        left join option_detail i on h.productOptionId = i.productOptionId
        left join business_phone j on d.businessId = j.businessId
        left join service_detail k on a.serviceId = k.serviceId
        left join category l on e.categoryId = l.categoryId
        where
        a.serviceId = #{serviceId}


    </select>

    <select id="GetServiceFlow">
        select a.serviceId, a.createdAt, a.price, a.completed, b.name as reservedName,
        a.name userName, c.startDate, e.name as productName, f.name as businessName
        from service A
        left join user B on a.userId = b.userId
        left join service_detail C on a.serviceId = c.serviceId
        left join product d on a.serviceId = d.serviceId
        left join detail_type e on d.detailTypeId = e.detailType
        left join business f on d.businessId = f.businessId
        where
        <if test="userId != null and businessId==null">
            b.userId = #{userId}
        </if>
        <if test="businessId != null and userId == null">
            f.businessId = #{businessId}
        </if>
    </select>
</mapper>