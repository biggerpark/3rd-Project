<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.jobdone.room.RoomMapper">
    <insert id="insRoom">
        insert into room
        set
        serviceId = #{serviceId}
    </insert>

    <select id="selRoom">
        select a.roomId, d.title, a.createdAt as roomCreatedAt,
        e.contents as chatContents, e.chatId
        from room a
        left join service b on a.serviceId = b.serviceId
        left join product c on b.productId = c.productId
        left join business d on c.businessId = d.businessId
        left join (select chatId, roomId, contents, row_number() over (partition by roomId order by chatId desc) as rn
                from chat) e on a.roomId = e.roomId
        where
        <if test="userId != null">
            b.userId = #{userId}
        </if>
        <if test="businessId != null">
            d.businessId = #{businessId}
        </if>
    </select>

</mapper>